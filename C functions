#include <stdio.h>
#include <stdlib.h>
#include <time.h>

int level = 1;
int hp = 100;
int hpmax = 100;
int dp = 10;
int xp = 0;
int xpmax = 100;
int diff = 20;
int monsterhp = 0;
int monsterhpmax;
int monsterdp = 0;
int just_leveled_up = 1;

void levelup()
{
    just_leveled_up, xp, level, hpmax, dp, hp, hpmax, xpmax;
    just_leveled_up = 1;
    xp = 0;
    level += 1;
    hpmax += 20;
    dp += 5;
    hp = hpmax;
    xpmax = 50 * 2 ^ level;
    printf("You leveled up! Your HP now is %d and your DP is %d", hp, dp);
}

void monster()
{
    monsterhp, monsterdp, monsterhpmax;
    monsterhp = diff + rand() % 2*diff;
    monsterhpmax = monsterhp;
    monsterdp = diff/4 + rand() % diff/2;
}
    
void fight()
{
    monsterhp, hp, xp, xpmax, diff;
    monster();
    while (monsterhp > 0) && (hp > 0)
    {
        monsterhp -= dp;
        printf("Hero attacks: Monster %d/%d HP", (max(0, monsterhp), monsterhpmax));
        if (monsterhp <= 0)
        {
            monsterhp = 0;
            xp += (monsterhp + monsterdp);
            if (xp >= xpmax)
            {
                levelup();
            }
            diff += 4;
            return TRUE;
        }
        else
        {
            hp -= monsterdp;
            printf("Monster attacks: Your %d/%d HP", (max(0, hp), hpmax));
        }
        if (hp <= 0)
        {
            hp = 0;
            printf("Game over. Your score is:%.2f", (level + xp/xpmax));
            return FALSE;
        }
    }
}
        
        
void rest(char amount;)
{
    hp, hpmax,  xp, xpmax;
    if (amount == 's')
    {
        if (hp < hpmax)
        {
            hp = min(hp + 0.1 * hpmax, hpmax);
            xp = max(xp - 0.1 * xpmax, 0);
        }
        else
        {
            printf("Your energy is full");
        }
    }
    else if (amount == 'l')
    {
        if (hp < hpmax)
        {
            hp = min(hp + 0.2 * hpmax, hpmax);
            xp = max(xp - 0.2 * xpmax, 0);
        }
        else
        {
            printf("Your energy is full");
        }
    }
}
    
/* this function prints the menu of choices after each fight that does not lead to levelup */
char menu()
{
    while (1)
    {
        char choices[5] = "FSLE";
        char choice;
        char buffer[80];
        printf("Please choose: \n");
        printf("[F] Fight without resting\n");
        printf("[S] Short rest, then fight\n");
        printf("[L] Long rest, then fight\n");
        printf("[E] Exit\n");
        printf("--> Please enter your choice: ");
        scanf("%s", buffer);
        choice=buffer[0];
        if (choice>='a' && choice<='z')
            choice = choice - 'a' + 'A';
        for (int i=0; i<5; i++)
            if (choice==choices[i])
                return choice;
        printf("Error: you did not give one of the choices, please try again\n\n");
    }
}

char menu2()
{
    while (1)
    {
        char decisions[3] = "NQ";
        char decision;
        char buffer[80];
        printf("Please choose: \n");
        printf("[N] New Fight \n");
        printf("[Q] Quit \n");
        printf("--> Please enter your choice: ");
        scanf("%s", buffer);
        decision=buffer[0];
        if (decision>='a' && decision<='z')
            decision = decision - 'a' + 'A';
        for (int i=0; i<5; i++)
            if (decision==decisions[i])
                return decision;
        printf("Error: you did not give one of the choices, please try again\n\n");
    }
}

int main()
{
    printf("Let's Play! You will fight with a moster. Let's go!");
    while (1)
    {
        if (just_leveled_up)
        {
            just_leveled_up = 0;
            decision = menu2();
            if (decision == 'N')
            {
                if (not fight())
                    break;
            }
            else if (decision == 'Q')
            {
                printf("your score is:%.2f", (level + xp/xpmax));
                break;
            }
        }
        
        else
        {
            choice = menu();
            if (choice == 'F')
            {
                if (not fight())
                    break;
            }
            else if (choice == 'S')
            {
                rest("s");
            }
            else if (choice == 'L')
            {
                rest("l");
            }
            else if (choice == 'E')
            {
                printf("your score is: %d", (level + xp/xpmax));
                break;
            }
        }
    }
    return 0;
}
